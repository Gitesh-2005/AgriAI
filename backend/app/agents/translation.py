import json
from typing import Dict, List
from app.agents.base import BaseAgent, AgentResponse

class TranslationAgent(BaseAgent):
    def __init__(self):
        super().__init__(
            name="Translation",
            description="Translates agricultural content between English and Indian regional languages"
        )
        
        # Agricultural terminology dictionary
        self.agri_terms = {
            "en_to_hi": {
                "farmer": "‡§ï‡§ø‡§∏‡§æ‡§®",
                "crop": "‡§´‡§∏‡§≤",
                "soil": "‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä",
                "water": "‡§™‡§æ‡§®‡•Ä",
                "fertilizer": "‡§â‡§∞‡•ç‡§µ‡§∞‡§ï",
                "seed": "‡§¨‡•Ä‡§ú",
                "harvest": "‡§´‡§∏‡§≤ ‡§ï‡§ü‡§æ‡§à",
                "irrigation": "‡§∏‡§ø‡§Ç‡§ö‡§æ‡§à",
                "pest": "‡§ï‡•Ä‡§ü",
                "disease": "‡§∞‡•ã‡§ó",
                "weather": "‡§Æ‡•å‡§∏‡§Æ",
                "rain": "‡§¨‡§æ‡§∞‡§ø‡§∂",
                "drought": "‡§∏‡•Ç‡§ñ‡§æ",
                "flood": "‡§¨‡§æ‡§¢‡§º",
                "market": "‡§¨‡§æ‡§ú‡§æ‡§∞",
                "price": "‡§ï‡•Ä‡§Æ‡§§",
                "subsidy": "‡§∏‡§¨‡•ç‡§∏‡§ø‡§°‡•Ä",
                "loan": "‡§ã‡§£",
                "insurance": "‡§¨‡•Ä‡§Æ‡§æ",
                "rice": "‡§ö‡§æ‡§µ‡§≤",
                "wheat": "‡§ó‡•á‡§π‡•Ç‡§Ç",
                "cotton": "‡§ï‡§™‡§æ‡§∏",
                "sugarcane": "‡§ó‡§®‡•ç‡§®‡§æ",
                "maize": "‡§Æ‡§ï‡•ç‡§ï‡§æ"
            },
            "hi_to_en": {
                "‡§ï‡§ø‡§∏‡§æ‡§®": "farmer",
                "‡§´‡§∏‡§≤": "crop",
                "‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä": "soil",
                "‡§™‡§æ‡§®‡•Ä": "water",
                "‡§â‡§∞‡•ç‡§µ‡§∞‡§ï": "fertilizer",
                "‡§¨‡•Ä‡§ú": "seed",
                "‡§´‡§∏‡§≤ ‡§ï‡§ü‡§æ‡§à": "harvest",
                "‡§∏‡§ø‡§Ç‡§ö‡§æ‡§à": "irrigation",
                "‡§ï‡•Ä‡§ü": "pest",
                "‡§∞‡•ã‡§ó": "disease",
                "‡§Æ‡•å‡§∏‡§Æ": "weather",
                "‡§¨‡§æ‡§∞‡§ø‡§∂": "rain",
                "‡§∏‡•Ç‡§ñ‡§æ": "drought",
                "‡§¨‡§æ‡§¢‡§º": "flood",
                "‡§¨‡§æ‡§ú‡§æ‡§∞": "market",
                "‡§ï‡•Ä‡§Æ‡§§": "price",
                "‡§∏‡§¨‡•ç‡§∏‡§ø‡§°‡•Ä": "subsidy",
                "‡§ã‡§£": "loan",
                "‡§¨‡•Ä‡§Æ‡§æ": "insurance",
                "‡§ö‡§æ‡§µ‡§≤": "rice",
                "‡§ó‡•á‡§π‡•Ç‡§Ç": "wheat",
                "‡§ï‡§™‡§æ‡§∏": "cotton",
                "‡§ó‡§®‡•ç‡§®‡§æ": "sugarcane",
                "‡§Æ‡§ï‡•ç‡§ï‡§æ": "maize"
            }
        }
        
        # Common agricultural phrases
        self.common_phrases = {
            "en_to_hi": {
                "How is your crop?": "‡§Ü‡§™‡§ï‡•Ä ‡§´‡§∏‡§≤ ‡§ï‡•à‡§∏‡•Ä ‡§π‡•à?",
                "What is the weather today?": "‡§Ü‡§ú ‡§Æ‡•å‡§∏‡§Æ ‡§ï‡•à‡§∏‡§æ ‡§π‡•à?",
                "When should I sow seeds?": "‡§Æ‡•Å‡§ù‡•á ‡§¨‡•Ä‡§ú ‡§ï‡§¨ ‡§¨‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è?",
                "What is the market price?": "‡§¨‡§æ‡§ú‡§æ‡§∞ ‡§≠‡§æ‡§µ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?",
                "How much fertilizer should I use?": "‡§Æ‡•Å‡§ù‡•á ‡§ï‡§ø‡§§‡§®‡§æ ‡§â‡§∞‡•ç‡§µ‡§∞‡§ï ‡§á‡§∏‡•ç‡§§‡•á‡§Æ‡§æ‡§≤ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è?",
                "Is there any government scheme?": "‡§ï‡•ç‡§Ø‡§æ ‡§ï‡•ã‡§à ‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§π‡•à?",
                "My crop is affected by pests": "‡§Æ‡•á‡§∞‡•Ä ‡§´‡§∏‡§≤ ‡§Æ‡•á‡§Ç ‡§ï‡•Ä‡§ü ‡§≤‡§ó‡•á ‡§π‡•à‡§Ç",
                "I need irrigation advice": "‡§Æ‡•Å‡§ù‡•á ‡§∏‡§ø‡§Ç‡§ö‡§æ‡§à ‡§ï‡•Ä ‡§∏‡§≤‡§æ‡§π ‡§ö‡§æ‡§π‡§ø‡§è"
            },
            "hi_to_en": {
                "‡§Ü‡§™‡§ï‡•Ä ‡§´‡§∏‡§≤ ‡§ï‡•à‡§∏‡•Ä ‡§π‡•à?": "How is your crop?",
                "‡§Ü‡§ú ‡§Æ‡•å‡§∏‡§Æ ‡§ï‡•à‡§∏‡§æ ‡§π‡•à?": "What is the weather today?",
                "‡§Æ‡•Å‡§ù‡•á ‡§¨‡•Ä‡§ú ‡§ï‡§¨ ‡§¨‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è?": "When should I sow seeds?",
                "‡§¨‡§æ‡§ú‡§æ‡§∞ ‡§≠‡§æ‡§µ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?": "What is the market price?",
                "‡§Æ‡•Å‡§ù‡•á ‡§ï‡§ø‡§§‡§®‡§æ ‡§â‡§∞‡•ç‡§µ‡§∞‡§ï ‡§á‡§∏‡•ç‡§§‡•á‡§Æ‡§æ‡§≤ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è?": "How much fertilizer should I use?",
                "‡§ï‡•ç‡§Ø‡§æ ‡§ï‡•ã‡§à ‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§π‡•à?": "Is there any government scheme?",
                "‡§Æ‡•á‡§∞‡•Ä ‡§´‡§∏‡§≤ ‡§Æ‡•á‡§Ç ‡§ï‡•Ä‡§ü ‡§≤‡§ó‡•á ‡§π‡•à‡§Ç": "My crop is affected by pests",
                "‡§Æ‡•Å‡§ù‡•á ‡§∏‡§ø‡§Ç‡§ö‡§æ‡§à ‡§ï‡•Ä ‡§∏‡§≤‡§æ‡§π ‡§ö‡§æ‡§π‡§ø‡§è": "I need irrigation advice"
            }
        }
    
    async def process(self, query: str, context: Dict = None) -> AgentResponse:
        """Process translation queries"""
        
        # Detect source and target languages
        source_lang, target_lang = self._detect_languages(query, context)
        
        # Extract text to translate
        text_to_translate = self._extract_text_to_translate(query)
        
        # Perform translation
        translated_text = self._translate_text(text_to_translate, source_lang, target_lang)
        
        # Format response
        response_text = self._format_translation_response(
            text_to_translate, translated_text, source_lang, target_lang
        )
        
        return AgentResponse(
            agent_name=self.name,
            response=response_text,
            confidence=0.8,
            metadata={
                "source_language": source_lang,
                "target_language": target_lang,
                "original_text": text_to_translate,
                "translated_text": translated_text,
                "translation_method": "dictionary_based"
            },
            citations=["Agricultural Terminology Dictionary", "Common Farming Phrases"]
        )
    
    def _detect_languages(self, query: str, context: Dict = None) -> tuple:
        """Detect source and target languages"""
        
        # Check context for language preferences
        if context:
            user_lang = context.get("language", "en")
            if user_lang == "hi":
                return "hi", "en"  # Hindi to English
            else:
                return "en", "hi"  # English to Hindi
        
        # Simple detection based on script
        if self._contains_devanagari(query):
            return "hi", "en"
        else:
            return "en", "hi"
    
    def _contains_devanagari(self, text: str) -> bool:
        """Check if text contains Devanagari script"""
        for char in text:
            if '\u0900' <= char <= '\u097F':  # Devanagari Unicode range
                return True
        return False
    
    def _extract_text_to_translate(self, query: str) -> str:
        """Extract the actual text to translate from query"""
        
        # Remove common translation request phrases
        translation_indicators = [
            "translate", "translation", "convert", "meaning", "hindi", "english",
            "‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶", "‡§Æ‡§§‡§≤‡§¨", "‡§Ö‡§∞‡•ç‡§•"
        ]
        
        words = query.split()
        filtered_words = []
        
        for word in words:
            if word.lower() not in translation_indicators:
                filtered_words.append(word)
        
        # If no meaningful text remains, use original query
        if not filtered_words:
            return query
        
        return " ".join(filtered_words)
    
    def _translate_text(self, text: str, source_lang: str, target_lang: str) -> str:
        """Translate text using dictionary and phrase matching"""
        
        # Check for exact phrase matches first
        phrase_dict = f"{source_lang}_to_{target_lang}"
        if phrase_dict in self.common_phrases:
            for phrase, translation in self.common_phrases[phrase_dict].items():
                if phrase.lower() in text.lower():
                    return translation
        
        # Word-by-word translation for agricultural terms
        term_dict = f"{source_lang}_to_{target_lang}"
        if term_dict in self.agri_terms:
            words = text.split()
            translated_words = []
            
            for word in words:
                # Clean word (remove punctuation)
                clean_word = word.strip(".,!?()[]{}\"'")
                
                # Check if it's an agricultural term
                if clean_word.lower() in self.agri_terms[term_dict]:
                    translated_words.append(self.agri_terms[term_dict][clean_word.lower()])
                elif clean_word in self.agri_terms[term_dict]:
                    translated_words.append(self.agri_terms[term_dict][clean_word])
                else:
                    # Keep original word if no translation found
                    translated_words.append(word)
            
            return " ".join(translated_words)
        
        # If no translation possible, return original with note
        return f"{text} (Translation not available - please use simpler agricultural terms)"
    
    def _format_translation_response(self, original: str, translated: str, 
                                   source_lang: str, target_lang: str) -> str:
        """Format translation response"""
        
        lang_names = {
            "en": "English",
            "hi": "Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)"
        }
        
        response = "üåê **Translation Service**\n\n"
        response += f"**Original ({lang_names[source_lang]}):** {original}\n\n"
        response += f"**Translation ({lang_names[target_lang]}):** {translated}\n\n"
        
        # Add helpful agricultural terms
        response += "**Common Agricultural Terms:**\n"
        
        if source_lang == "en":
            sample_terms = [
                ("Farmer", "‡§ï‡§ø‡§∏‡§æ‡§®"),
                ("Crop", "‡§´‡§∏‡§≤"),
                ("Soil", "‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä"),
                ("Water", "‡§™‡§æ‡§®‡•Ä"),
                ("Fertilizer", "‡§â‡§∞‡•ç‡§µ‡§∞‡§ï")
            ]
        else:
            sample_terms = [
                ("‡§ï‡§ø‡§∏‡§æ‡§®", "Farmer"),
                ("‡§´‡§∏‡§≤", "Crop"),
                ("‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä", "Soil"),
                ("‡§™‡§æ‡§®‡•Ä", "Water"),
                ("‡§â‡§∞‡•ç‡§µ‡§∞‡§ï", "Fertilizer")
            ]
        
        for term1, term2 in sample_terms:
            response += f"‚Ä¢ {term1} = {term2}\n"
        
        response += "\n**üí° Tip:** For better translations, use simple agricultural terms and phrases."
        
        return response
    
    async def translate_response(self, text: str, target_language: str) -> str:
        """Translate AI response to target language"""
        
        if target_language == "hi":
            # Translate key agricultural terms in the response
            translated_text = text
            
            for en_term, hi_term in self.agri_terms["en_to_hi"].items():
                # Case-insensitive replacement
                import re
                pattern = re.compile(re.escape(en_term), re.IGNORECASE)
                translated_text = pattern.sub(hi_term, translated_text)
            
            return translated_text
        
        return text  # Return original if target is English or unsupported